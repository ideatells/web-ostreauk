---
import { STRAPI_URL } from '../constants';
import { getTranslations } from '../lib/i18n';
import type { BlogPostData, Locale } from '../lib/strapi';

interface Props {
  post: BlogPostData;
  locale: Locale;
}

const { post, locale } = Astro.props;
const t = getTranslations(locale);

function resolveMediaUrl(url: string): string {
  if (url.startsWith('http://') || url.startsWith('https://')) {
    return url;
  }

  return `${STRAPI_URL}${url}`;
}

function applyCloudinaryTransform(url: string, transform: string): string {
  return url.includes('/upload/')
    ? url.replace('/upload/', `/upload/${transform}/`)
    : url;
}

const featuredImageUrl = post.featured_image?.attributes?.url
  ? applyCloudinaryTransform(
      resolveMediaUrl(post.featured_image.attributes.url),
      'f_auto,q_auto,w_600,h_400,c_fill'
    )
  : null;

const excerpt =
  post.excerpt && post.excerpt.length > 120
    ? `${post.excerpt.slice(0, 117).trim()}...`
    : post.excerpt;

const formattedDate = new Intl.DateTimeFormat(locale, {
  year: 'numeric',
  month: 'long',
  day: 'numeric',
}).format(new Date(post.publish_date));

const postUrl = `/${locale}/blog/${post.slug}`;
---

<article class="overflow-hidden rounded-lg border bg-white shadow-sm transition-shadow hover:shadow-md">
  <a href={postUrl} class="block h-full" aria-label={`${post.title} - ${t.blog.readMore}`}>
    {
      featuredImageUrl ? (
        <img
          src={featuredImageUrl}
          alt={post.featured_image?.attributes?.alternativeText || post.title}
          class="aspect-[3/2] w-full object-cover"
          loading="lazy"
          decoding="async"
        />
      ) : (
        <div class="aspect-[3/2] w-full bg-slate-100" aria-hidden="true" />
      )
    }
    <div class="flex h-full flex-col p-5">
      {post.category?.name && (
        <span class="mb-3 inline-flex w-fit items-center rounded-full bg-brand-green/10 px-3 py-1 text-xs font-medium text-brand-green">
          {post.category.name}
        </span>
      )}
      <h3 class="text-lg font-semibold text-slate-900">{post.title}</h3>
      {excerpt && <p class="mt-3 text-sm text-slate-600">{excerpt}</p>}
      <div class="mt-4 flex items-center justify-between gap-4">
        <time datetime={post.publish_date} class="text-xs text-slate-500">
          {formattedDate}
        </time>
        <span class="text-sm font-medium text-brand-green">{t.blog.readMore}</span>
      </div>
    </div>
  </a>
</article>
