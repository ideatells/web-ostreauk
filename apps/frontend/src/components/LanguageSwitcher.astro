---
import type { Locale } from '../lib/strapi';

interface Props {
  currentLocale: Locale;
}

const { currentLocale } = Astro.props;
const selectId = `language-select-${Math.random().toString(36).slice(2, 8)}`;
---

<div
  data-language-switcher
  data-current-locale={currentLocale}
  class="inline-flex items-center gap-2"
>
  <label for={selectId} class="sr-only">Select language</label>
  <select
    id={selectId}
    aria-label="Select language"
    class="h-9 min-w-32 rounded-md border border-slate-300 bg-white px-3 text-sm text-slate-900 shadow-sm transition-colors focus:border-brand-green focus:outline-none focus:ring-2 focus:ring-brand-green focus:ring-offset-2"
  >
    <option value="nl" selected={currentLocale === 'nl'}>Nederlands</option>
    <option value="en" selected={currentLocale === 'en'}>English</option>
  </select>
</div>

<script is:inline>
  const switchers = document.querySelectorAll('[data-language-switcher]');

  for (const switcher of switchers) {
    const select = switcher.querySelector('select');
    const fromLocale = switcher.getAttribute('data-current-locale');

    if (!select || (fromLocale !== 'nl' && fromLocale !== 'en')) {
      continue;
    }

    select.addEventListener('change', async (event) => {
      const target = event.target;

      if (!(target instanceof HTMLSelectElement)) {
        return;
      }

      const nextLocale = target.value;
      if (nextLocale !== 'nl' && nextLocale !== 'en') {
        return;
      }

      const { translatePath } = await import('../lib/i18n');
      const currentPathWithQuery = `${window.location.pathname}${window.location.search}${window.location.hash}`;
      const translatedPath = translatePath(currentPathWithQuery, fromLocale, nextLocale);
      window.location.href = translatedPath;
    });
  }
</script>
