---
import BlogCard from '../../../components/BlogCard.astro';
import BaseLayout from '../../../layouts/BaseLayout.astro';
import { BLOG_POSTS_PER_PAGE } from '../../../constants';
import { getTranslations, validateLocale } from '../../../lib/i18n';
import { fetchBlogCategories, fetchBlogPosts, type Locale } from '../../../lib/strapi';

export function getStaticPaths() {
  return [{ params: { lang: 'nl' } }, { params: { lang: 'en' } }];
}

const langParam = Astro.params.lang ?? 'nl';
if (!validateLocale(langParam)) {
  throw new Error(`Unsupported locale: ${langParam}`);
}
const lang: Locale = langParam;
const t = getTranslations(lang);

const pageParam = Astro.url.searchParams.get('page') || '1';
const categoryParam = Astro.url.searchParams.get('category') || undefined;
const parsedPage = Number.parseInt(pageParam, 10);
const currentPage = Number.isFinite(parsedPage) && parsedPage > 0 ? parsedPage : 1;

const [postsResponse, categoriesResponse] = await Promise.all([
  fetchBlogPosts(lang, currentPage, BLOG_POSTS_PER_PAGE, categoryParam),
  fetchBlogCategories(lang),
]);

const posts = postsResponse.data;
const categories = categoriesResponse.data;
const totalPages = postsResponse.meta.pagination.pageCount;
const hasPrevPage = currentPage > 1;
const hasNextPage = currentPage < totalPages;

function buildPageUrl(page: number, category?: string): string {
  const params = new URLSearchParams();
  if (category) {
    params.set('category', category);
  }
  if (page > 1) {
    params.set('page', String(page));
  }
  const query = params.toString();
  return query ? `?${query}` : '';
}
---

<BaseLayout
  title={lang === 'nl' ? 'Blog' : 'Blog'}
  description={lang === 'nl' ? 'Nieuws en inzichten van Ostrea.' : 'News and insights from Ostrea.'}
  lang={lang}
>
  <section class="mx-auto max-w-7xl px-4 py-12 md:py-16">
    <h1 class="text-3xl font-bold text-slate-900 md:text-4xl">Blog</h1>

    <div class="mt-6 flex flex-col gap-2 sm:max-w-xs">
      <label for="category-filter" class="text-sm font-medium text-slate-700">{t.blog.category}</label>
      <select
        id="category-filter"
        class="rounded-md border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900"
        data-current-page={currentPage}
      >
        <option value="">{t.blog.allCategories}</option>
        {
          categories.map((category) => (
            <option value={category.slug} selected={category.slug === categoryParam}>
              {category.name}
            </option>
          ))
        }
      </select>
    </div>

    {
      posts.length > 0 ? (
        <div class="mt-8 grid grid-cols-1 gap-6 md:grid-cols-2 lg:grid-cols-3">
          {posts.map((post) => <BlogCard post={post} locale={lang} />)}
        </div>
      ) : (
        <p class="mt-8 rounded-md border border-slate-200 bg-slate-50 px-4 py-6 text-slate-700">
          {t.blog.noPostsFound}
        </p>
      )
    }

    {
      totalPages > 1 && (
        <nav class="mt-8" aria-label="Pagination">
          <div class="flex items-center justify-center gap-2">
            {hasPrevPage ? (
              <a
                href={buildPageUrl(currentPage - 1, categoryParam)}
                class="rounded-md border border-slate-300 px-3 py-2 text-sm text-slate-700 hover:bg-slate-50"
              >
                {lang === 'nl' ? 'Vorige' : 'Previous'}
              </a>
            ) : (
              <span class="rounded-md border border-slate-200 px-3 py-2 text-sm text-slate-400">
                {lang === 'nl' ? 'Vorige' : 'Previous'}
              </span>
            )}

            {Array.from({ length: totalPages }, (_, index) => index + 1).map((pageNumber) => (
              <a
                href={buildPageUrl(pageNumber, categoryParam)}
                aria-current={pageNumber === currentPage ? 'page' : undefined}
                class:list={[
                  'rounded-md px-3 py-2 text-sm',
                  pageNumber === currentPage
                    ? 'bg-brand-green text-white'
                    : 'border border-slate-300 text-slate-700 hover:bg-slate-50',
                ]}
              >
                {pageNumber}
              </a>
            ))}

            {hasNextPage ? (
              <a
                href={buildPageUrl(currentPage + 1, categoryParam)}
                class="rounded-md border border-slate-300 px-3 py-2 text-sm text-slate-700 hover:bg-slate-50"
              >
                {lang === 'nl' ? 'Volgende' : 'Next'}
              </a>
            ) : (
              <span class="rounded-md border border-slate-200 px-3 py-2 text-sm text-slate-400">
                {lang === 'nl' ? 'Volgende' : 'Next'}
              </span>
            )}
          </div>
        </nav>
      )
    }
  </section>
</BaseLayout>

<script>
  const select = document.getElementById('category-filter');
  if (select instanceof HTMLSelectElement) {
    select.addEventListener('change', () => {
      const selected = select.value;
      const params = new URLSearchParams(window.location.search);
      if (selected) {
        params.set('category', selected);
      } else {
        params.delete('category');
      }
      params.delete('page');
      const query = params.toString();
      window.location.href = query ? `?${query}` : window.location.pathname;
    });
  }
</script>
