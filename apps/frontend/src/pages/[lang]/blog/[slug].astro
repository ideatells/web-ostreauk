---
import BlogCard from '../../../../components/BlogCard.astro';
import BaseLayout from '../../../../layouts/BaseLayout.astro';
import { STRAPI_URL } from '../../../../constants';
import { fetchBlogPosts, type BlogPostData, type Locale } from '../../../../lib/strapi';
import { SUPPORTED_LOCALES } from '../../../../lib/i18n';

export async function getStaticPaths() {
  const PAGE_SIZE = 100;
  const allPaths = await Promise.all(
    SUPPORTED_LOCALES.map(async (locale) => {
      const allPosts: BlogPostData[] = [];
      let page = 1;
      let pageCount = 1;

      while (page <= pageCount) {
        const postsResponse = await fetchBlogPosts(locale, page, PAGE_SIZE);
        allPosts.push(...postsResponse.data);
        pageCount = postsResponse.meta.pagination.pageCount;
        page += 1;
      }

      return allPosts.map((post) => ({
        params: { lang: locale, slug: post.slug },
        props: { post, lang: locale },
      }));
    })
  );

  return allPaths.flat();
}

interface Props {
  post: BlogPostData;
  lang: Locale;
}

const { post, lang } = Astro.props;

function resolveMediaUrl(url: string): string {
  if (url.startsWith('http://') || url.startsWith('https://')) {
    return url;
  }

  return `${STRAPI_URL}${url}`;
}

function applyCloudinaryTransform(url: string, transform: string): string {
  return url.includes('/upload/')
    ? url.replace('/upload/', `/upload/${transform}/`)
    : url;
}

const featuredImageUrl = post.featured_image?.attributes?.url
  ? applyCloudinaryTransform(
      resolveMediaUrl(post.featured_image.attributes.url),
      'f_auto,q_auto,w_1920,h_600,c_fill'
    )
  : null;

const formattedDate = new Intl.DateTimeFormat(lang, {
  year: 'numeric',
  month: 'long',
  day: 'numeric',
}).format(new Date(post.publish_date));

const relatedResponse = post.category?.slug
  ? await fetchBlogPosts(lang, 1, 4, post.category.slug)
  : { data: [] };
const relatedPosts = relatedResponse.data.filter((candidate) => candidate.id !== post.id).slice(0, 3);

const title = post.seo?.seo_title || post.title;
const description = post.seo?.seo_description || post.excerpt || '';
---

<BaseLayout title={title} description={description} lang={lang}>
  <article class="mx-auto max-w-4xl px-4 py-12">
    {
      featuredImageUrl && (
        <img
          src={featuredImageUrl}
          alt={post.featured_image?.attributes?.alternativeText || post.title}
          class="mb-8 aspect-video w-full rounded-lg object-cover"
          loading="eager"
          decoding="async"
        />
      )
    }
    <header class="mb-6">
      <h1 class="text-3xl font-bold text-slate-900 md:text-4xl">{post.title}</h1>
      <div class="mt-4 flex items-center gap-4 text-sm text-slate-600">
        <time datetime={post.publish_date}>{formattedDate}</time>
        {
          post.category?.name && (
            <span class="inline-flex items-center rounded-full bg-brand-green/10 px-3 py-1 text-sm font-medium text-brand-green">
              {post.category.name}
            </span>
          )
        }
      </div>
    </header>

    <div class="prose prose-lg prose-slate max-w-none" set:html={post.body || ''} />
  </article>

  {
    relatedPosts.length > 0 && (
      <section class="mx-auto max-w-7xl px-4 pb-12 md:pb-16">
        <h2 class="text-2xl font-bold text-slate-900 md:text-3xl">
          {lang === 'nl' ? 'Gerelateerde berichten' : 'Related posts'}
        </h2>
        <div class="mt-6 grid grid-cols-1 gap-6 md:grid-cols-3">
          {relatedPosts.map((relatedPost) => <BlogCard post={relatedPost} locale={lang} />)}
        </div>
      </section>
    )
  }
</BaseLayout>
